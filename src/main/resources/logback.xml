<?xml version="1.0" encoding="UTF-8" ?>
<configuration scan="true" scanPeriod="60 seconds" debug="false">
    <contextName>${contextName:-logserver}</contextName>
    <property name="logLevel" value="${logLevel:-DEBUG}"/>
    <property name="logPort" value="${logPort:-6000}"/>
    <property name="logPattern" value="%cn %d{HH:mm:ss.SSS} %-5level [%thread] %logger{0}:%L %.-${logLength:-2048}msg%n"/>
    
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="com.xlongwei.logserver.PatternsLayoutEncoder">
            <pattern>${logPattern}</pattern>
        </encoder>
    </appender>
    
    <if condition='isDefined("logfile")'>
	    <then>
		    <if condition='property("logfile").isEmpty()'>
			    <then>
				    <property name="logfile" value="logs/all.logs"/>
			    </then>
		    </if>
		    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
		        <file>${logfile}</file>
		        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
		            <fileNamePattern>${logfile}.%d{yyyy-MM-dd}</fileNamePattern>
		        </rollingPolicy>
		        <encoder class="com.xlongwei.logserver.PatternsLayoutEncoder">
		            <pattern>${logPattern}</pattern>
		        </encoder>
		    </appender>
			<appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
				<appender-ref ref="FILE" />
			</appender>
	    </then>
    </if>
    
    <if condition='isDefined("filebeat")'>
	    <then>
			<appender name="SOCKET" class="ch.qos.logback.classic.net.SocketAppender">
				<RemoteHost>logserver</RemoteHost>
				<Port>6000</Port>
				<ReconnectionDelay>10000</ReconnectionDelay>
				<IncludeCallerData>false</IncludeCallerData>
			</appender>
			<appender name="ASYNC_SOCKET" class="ch.qos.logback.classic.AsyncAppender">
				<appender-ref ref="SOCKET" />
				<IncludeCallerData>true</IncludeCallerData>
			</appender>
			<logger name="filebeat" level="INFO" additivity="false">
				<appender-ref ref="ASYNC_SOCKET" />
			</logger>			
	    </then>
	    <else>
			<receiver class="ch.qos.logback.classic.net.server.ServerSocketReceiver">
				<port>${logPort}</port>
			</receiver>
	    </else>
    </if>    
	
	<logger name="com.xlongwei.logserver" level="INFO" additivity="false">
		<appender-ref ref="STDOUT" />
	</logger>
	<logger name="com.networknt" level="WARN" additivity="false">
		<appender-ref ref="STDOUT" />
	</logger>
	<logger name="io.undertow" level="WARN" additivity="false">
		<appender-ref ref="STDOUT" />
	</logger>
	<logger name="org.xnio" level="WARN" additivity="false">
		<appender-ref ref="STDOUT" />
	</logger>
	<logger name="org.jboss" level="WARN" additivity="false">
		<appender-ref ref="STDOUT" />
	</logger>

	<root level="${logLevel}">
		<if condition='isDefined("logfile")'>
		    <then>
				<appender-ref ref="ASYNC_FILE" />
		    </then>		
			<else>
				<appender-ref ref="STDOUT" />
			</else>
		</if>
	</root>
</configuration>